## 浏览器的发展

**应用程序Web化。** 随着云计算的普及和 HTML5 技术的快速发展，越来越多的应用转向了浏览器 / 服务器（B/S）架构，这种改变让浏览器的重要性与日俱增，视频、音频、游戏几大核心场景也都在往 Web 的使用场景切换。  
  
  
**Web应用移动化。** 对于移动设备应用，Web 天生具有开放的基因，虽然在技术层面还有问题尚待解决（比如，渲染流程过于复杂且性能不及原生应用、离线时用户无法使用、无法接收消息推送、移动端没有一级入口），但 Google 推出了 PWA 方案来整合 Web 和本地程序各自的优势。


**Web操作系统化。** 在我看来，Web 操作系统有两层含义：一是利用 Web 技术构建一个纯粹的操作系统，如 ChromeOS；二是浏览器的底层结构往操作系统架构方向发展，在整个架构演化的大背景下会牵涉诸多改变，下面列举一些我认为相对重要的改变。
* Chrome 朝着 SOA 的方向演化，未来很多模块都会以服务的形式提供给上层应用使用
* 在浏览器中引入多种编程语言的支持，比如新支持的 WebAssembly；
* 简化渲染流程，使得渲染过程更加直接高效；加大对系统设备特性的支持；
* 提供对复杂 Web 项目开发的支持。

### 为什么需要学习浏览器工作原理？
1. 准确评估 Web 开发项目的可行性

2. 从更高维度审视页面
常见的用户体验指标。
* 当用户请求一个网站时，如果在 1 秒内看不到关键内容，用户会产生任务被中断的感觉。
* 当用户点击某些按钮时，如果 100ms 内无法响应，用户会感受到延迟。
* 如果 Web 中的动画没有达到 60fps，用户会感受到动画的卡顿。

3. 在快节奏的技术迭代中把握本质



## Chrome架构

### 进程和线程

* 线程是不能单独存在的，它是由进程来启动和管理的
* **一个进程就是一个程序的运行实例。** 详细解释就是，启动一个程序的时候，操作系统会为该程序创建一块内存，用来存放代码、运行中的数据和一个执行任务的主线程，我们把这样的一个运行环境叫进程。
![img](https://static001.geekbang.org/resource/image/33/da/3380f0a16c323deda5d3a300804b95da.png?wh=1142*575)
* 线程是依附于进程的，而进程中使用多线程并行处理能提升运算效率。

#### 进程和线程之间的关系有以下 4 个特点
1. 进程中的任意一线程执行出错，都会导致整个进程的崩溃。
2. 线程之间共享进程中的数据。
![img](https://static001.geekbang.org/resource/image/d0/9e/d0efacd7f299ed99e776cb97da2a799e.png?wh=1142*789)
3. 当一个进程关闭之后，操作系统会回收进程所占用的内存。当一个进程退出时，操作系统会回收该进程所申请的所有资源；即使其中任意线程因为操作不当导致内存泄漏，当进程退出时，这些内存也会被正确回收。
4. 进程之间的内容相互隔离。如果进程之间需要进行数据的通信，这时候，就需要使用用于进程间通信（IPC）的机制了。

### 目前多进程架构
![img](https://static001.geekbang.org/resource/image/b6/fc/b61cab529fa31301bde290813b4587fc.png?wh=1142*494)

从图中可以看出，最新的 Chrome 浏览器包括：1 个浏览器（Browser）主进程、1 个 GPU 进程、1 个网络（NetWork）进程、多个渲染进程和多个插件进程。

* **浏览器进程。** 主要负责界面显示、用户交互、子进程管理，同时提供存储等功能。

* **渲染进程。** 核心任务是将 HTML、CSS 和 JavaScript 转换为用户可以与之交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 都是运行在该进程中，默认情况下，Chrome 会为每个 Tab 标签创建一个渲染进程。出于安全考虑，渲染进程都是运行在沙箱模式下。

* **GPU 进程。** 其实，Chrome 刚开始发布的时候是没有 GPU 进程的。而 GPU 的使用初衷是为了实现 3D CSS 的效果，只是随后网页、Chrome 的 UI 界面都选择采用 GPU 来绘制，这使得 GPU 成为浏览器普遍的需求。最后，Chrome 在其多进程架构上也引入了 GPU 进程。

* **网络进程。** 主要负责页面的网络资源加载，之前是作为一个模块运行在浏览器进程里面的，直至最近才独立出来，成为一个单独的进程。

* **插件进程。** 主要是负责插件的运行，因插件易崩溃，所以需要通过插件进程来隔离，以保证插件进程崩溃不会对浏览器和页面造成影响。


### 未来面向服务的架构
Chrome 整体架构会朝向现代操作系统所采用的“面向服务的架构” 方向发展，原来的各种模块会被重构成独立的服务（Service），每个服务（Service）都可以在独立的进程中运行，访问服务（Service）必须使用定义好的接口，通过 IPC 来通信，从而 **构建一个更内聚、松耦合、易于维护和扩展的系统，** 更好实现 Chrome 简单、稳定、高速、安全的目标。

![img](https://static001.geekbang.org/resource/image/32/2a/329658fe821252db47b0964037a1de2a.png?wh=1142*582)


## TCP协议
1. IP：把数据包送达目的主机
计算机的地址就称为 IP 地址，访问任何网站实际上只是你的计算机向另外一台计算机请求信息。

2. UDP：把数据包送达应用程序
IP 通过 IP 地址信息把数据包发送给指定的电脑，而 UDP 通过端口号把数据包分发给正确的程序。
![img](https://static001.geekbang.org/resource/image/3e/ea/3edb673a43f23d84253c52124ce447ea.png?wh=1142*814)


3. TCP：把数据完整地送达应用程序
TCP（Transmission Control Protocol，传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议。
![img](https://static001.geekbang.org/resource/image/94/32/943ac29f7d5b45a8861b0cde5da99032.png?wh=1142*798)

### 一个完整的 TCP 连接的生命周期包括了“建立连接”“传输数据”和“断开连接”三个阶段。
![img](https://static001.geekbang.org/resource/image/44/44/440ee50de56edc27c6b3c992b3a25844.png?wh=1142*408)
* 首先，建立连接阶段。这个阶段是通过“三次握手”来建立客户端和服务器之间的连接。TCP 提供面向连接的通信传输。面向连接是指在数据通信开始之前先做好两端之间的准备工作。所谓三次握手，是指在建立一个 TCP 连接时，客户端和服务器总共要发送三个数据包以确认连接的建立。

* 其次，传输数据阶段。在该阶段，接收端需要对每个数据包进行确认操作，也就是接收端在接收到数据包之后，需要发送确认数据包给发送端。所以当发送端发送了一个数据包之后，在规定时间内没有接收到接收端反馈的确认消息，则判断为数据包丢失，并触发发送端的重发机制。同样，一个大的文件在传输过程中会被拆分成很多小的数据包，这些数据包到达接收端后，接收端会按照 TCP 头中的序号为其排序，从而保证组成完整的数据。

* 最后，断开连接阶段。数据传输完毕之后，就要终止连接了，涉及到最后一个阶段“四次挥手”来保证双方都能断开连接。



## HTTP请求流程

HTTP 是一种允许浏览器向服务器获取资源的协议，是 Web 的基础

### 浏览器端发起 HTTP 请求流程

1. 构建请求

```html
GET /index.html HTTP1.1
```

2. 查找缓存
浏览器缓存是一种在本地保存资源副本，以供下次请求时直接使用的技术。当浏览器发现请求的资源已经在浏览器缓存中存有副本，它会拦截请求，返回该资源的副本，并直接结束请求，而不会再去源服务器重新下载。这样做的好处有：

* 缓解服务器端压力，提升性能（获取资源的耗时更短了）；

* 对于网站来说，缓存是实现快速资源加载的重要组成部分。

3. 准备 IP 地址和端口
因为浏览器使用 **HTTP 协议作为应用层协议**，用来封装请求的文本信息；并使用**TCP/IP 作传输层协议**将它发到网络上，所以在 HTTP 工作开始之前，浏览器需要通过 TCP 与服务器建立连接。也就是说 **HTTP 的内容是通过 TCP 的传输数据阶段来实现的**，你可以结合下图更好地理解这二者的关系。

![img](https://static001.geekbang.org/resource/image/12/80/1277f342174b23f9442d3b27016d7980.png?wh=1142*570)

4. 等待 TCP 队列
Chrome 有个机制，同一个域名同时最多只能建立 6 个 TCP 连接，如果在同一个域名下同时有 10 个请求发生，那么其中 4 个请求会进入排队等待状态，直至进行中的请求完成。

5. 建立 TCP 连接

6. 发送 HTTP 请求

![img](https://static001.geekbang.org/resource/image/b8/d7/b8993c73f7b60feb9b8bd147545c47d7.png?wh=1142*656)


### 服务器端处理 HTTP 请求流程

1. 返回请求

一旦服务器处理结束，便可以返回数据给浏览器了。你可以通过工具软件 curl 来查看返回请求数据，具体使用方法是在命令行中输入以下命令：

```html
curl -i  https://time.geekbang.org/
```

2. 断开连接

3. 重定向


### 问题解答

#### 1. 为什么很多站点第二次打开速度会很快？

如果第二次页面打开很快，主要原因是第一次加载页面过程中，缓存了一些耗时的数据。

![img](https://static001.geekbang.org/resource/image/5f/08/5fc2f88a04ee0fc41a808f3481287408.png?wh=1142*1258)

#### 2. 登录状态是如何保持的？

![img](https://static001.geekbang.org/resource/image/d9/b3/d9d6cefe8d3d6d84a37a626687c6ecb3.png?wh=1142*932)